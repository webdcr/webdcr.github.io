<div class="nowplaying-banner" role="region" aria-live="polite">
  <div class="nowplaying-inner">
    <div class="nowplaying-cover">
      <img
        src="/assets/images/showalbums/placeholder.png"
        alt="Artwork for the show that is currently live"
        id="nowplayingImage"
      />
    </div>
    <div class="nowplaying-copy">
      <p class="nowplaying-eyebrow">On air now</p>
      <p class="nowplaying-title" id="nowplayingTitle">WebDCR Music</p>
      <p class="nowplaying-host" id="nowplayingHost">No show is currently playing</p>
      <p class="nowplaying-description" style="display:none">
        <span class="nowplaying-description-track">
          <span class="nowplaying-description-segment">
            <span class="nowplaying-description-text" id="nowplayingDescription"></span>
            <span class="nowplaying-description-divider" aria-hidden="true">•</span>
          </span>
          <span class="nowplaying-description-segment" aria-hidden="true">
            <span class="nowplaying-description-text" id="nowplayingDescriptionClone"></span>
            <span class="nowplaying-description-divider" aria-hidden="true">•</span>
          </span>
        </span>
      </p>
    </div>
    <button
      type="button"
      id="radioPlayer"
      class="radioPlayer"
      x-data
      :data-mode="$store.radioPlayer ? $store.radioPlayer.state : 'stopped'"
      aria-label="Toggle the live stream"
      :aria-pressed="$store.radioPlayer ? ($store.radioPlayer.state === 'playing').toString() : 'false'"
      @click="$store.radioPlayer && $store.radioPlayer.toggle()"
    ></button>
  </div>
</div>

<header class="site-header">
  <a class="wordmark-group wordmark-link" href="/" aria-label="WebDCR home">
    <h1 id="wordmark">WEBDCR</h1>
    <p class="tagline">Dartmouth College Radio</p>
  </a>

  <nav class="navbar" aria-label="Primary">
    <div class="nav-row">
      <a class="navitem" id="nav_home" href="/">home</a>
      <a class="navitem" id="nav_news" href="/news">news &amp; reports</a>
      <a class="navitem" id="nav_blog" href="/musicblog">music blog</a>
    </div>
    <div class="nav-row">
      <a class="navitem" id="nav_about" href="/about">about</a>
      <a class="navitem" id="nav_merch" href="/merch">merch</a>
      <a class="navitem" id="nav_alumni" href="/alumni">alumni corner</a>
    </div>
  </nav>
</header>

<script>
  window.WEBDCR_SHOWS = window.WEBDCR_SHOWS || {{ site.data.shows | jsonify }};
  window.webdcr = window.webdcr || {};
  window.webdcr.parseTimeToMinutes = function (timeString) {
    if (!timeString) {
      return NaN;
    }
    const trimmed = String(timeString).trim();
    const match = trimmed.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?$/i);
    if (!match) {
      return NaN;
    }
    let hours = parseInt(match[1], 10);
    const minutes = match[2] ? parseInt(match[2], 10) : 0;
    const meridiem = match[3] ? match[3].toUpperCase() : null;
    if (meridiem === "PM" && hours < 12) {
      hours += 12;
    }
    if (meridiem === "AM" && hours === 12) {
      hours = 0;
    }
    if (!meridiem && (hours < 0 || hours >= 24)) {
      return NaN;
    }
    if (minutes < 0 || minutes >= 60) {
      return NaN;
    }
    return hours * 60 + minutes;
  };
</script>

<script>
  document.addEventListener('alpine:init', () => {
    const radioURL = "{{ site.liveradio_url | escape }}";
    const STORAGE_KEY = 'webdcr.radio.playing';

    Alpine.store('radioPlayer', {
      state: 'stopped',
      audio: null,
      isPageUnloading: false,
      resumeInteractionHandler: null,
      init() {
        this.registerLifecycleHandlers();
        this.resumeIfNeeded();
      },
      isActive() {
        return this.state === 'playing' || this.state === 'loading';
      },
      registerLifecycleHandlers() {
        const exitHandler = () => this.handlePageExit();
        window.addEventListener('pagehide', exitHandler);
        window.addEventListener('beforeunload', exitHandler);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'hidden') {
            this.handlePageExit();
          } else {
            this.isPageUnloading = false;
          }
        });
      },
      ensureAudio() {
        if (this.audio) {
          return;
        }
        this.audio = new Audio(radioURL);
        this.audio.preload = 'none';
        this.audio.addEventListener('waiting', () => this.setState('loading'));
        this.audio.addEventListener('playing', () => {
          this.isPageUnloading = false;
          this.setState('playing');
          this.cancelResumeOnInteraction();
          this.rememberPlaybackPreference();
        });
        this.audio.addEventListener('pause', () => {
          this.setState('stopped');
          if (!this.isPageUnloading) {
            this.cancelResumeOnInteraction();
            this.clearPlaybackPreference();
          }
        });
        ['ended', 'error'].forEach((eventName) => {
          this.audio.addEventListener(eventName, () => {
            this.setState('stopped');
            this.cancelResumeOnInteraction();
            this.clearPlaybackPreference();
          });
        });
      },
      setState(state) {
        this.state = state;
      },
      toggle() {
        if (this.state === 'playing' || this.state === 'loading') {
          this.pause();
        } else {
          this.play();
        }
      },
      play(options = {}) {
        const initiatedByResume = !!options.initiatedByResume;
        this.ensureAudio();
        if (!this.audio) {
          return;
        }
        this.cancelResumeOnInteraction();
        this.setState('loading');
        try {
          this.audio.load();
          const playPromise = this.audio.play();
          if (playPromise && typeof playPromise.catch === 'function') {
            playPromise.catch((err) => {
              this.handlePlayError(err, initiatedByResume);
            });
          }
        } catch (err) {
          this.handlePlayError(err, initiatedByResume);
        }
      },
      pause() {
        if (this.audio) {
          this.audio.pause();
        } else {
          this.setState('stopped');
        }
      },
      rememberPlaybackPreference() {
        try {
          localStorage.setItem(STORAGE_KEY, '1');
        } catch (e) {}
      },
      clearPlaybackPreference() {
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (e) {}
      },
      handlePageExit() {
        if (this.isActive()) {
          this.isPageUnloading = true;
          this.rememberPlaybackPreference();
        }
      },
      resumeIfNeeded() {
        try {
          if (localStorage.getItem(STORAGE_KEY) === '1') {
            this.play({ initiatedByResume: true });
          }
        } catch (e) {}
      },
      handlePlayError(err, initiatedByResume) {
        if (initiatedByResume && this.isAutoplayBlockedError(err)) {
          // Autoplay gets rejected until a user interacts with the page again.
          this.setState('stopped');
          this.scheduleResumeOnInteraction();
          return;
        }
        this.setState('stopped');
        this.clearPlaybackPreference();
      },
      isAutoplayBlockedError(err) {
        if (!err) {
          return false;
        }
        const name = err.name || '';
        if (name === 'NotAllowedError' || name === 'SecurityError') {
          return true;
        }
        if (typeof err.message === 'string') {
          const lowercase = err.message.toLowerCase();
          return (
            lowercase.includes('gesture') ||
            lowercase.includes('interaction') ||
            lowercase.includes('autoplay') ||
            lowercase.includes('not allowed')
          );
        }
        return false;
      },
      scheduleResumeOnInteraction() {
        if (this.resumeInteractionHandler) {
          return;
        }
        // Resume immediately on the next user gesture.
        this.resumeInteractionHandler = () => {
          this.cancelResumeOnInteraction();
          this.play({ initiatedByResume: true });
        };
        ['pointerdown', 'keydown', 'touchstart'].forEach((eventName) => {
          window.addEventListener(eventName, this.resumeInteractionHandler, { once: true });
        });
      },
      cancelResumeOnInteraction() {
        if (!this.resumeInteractionHandler) {
          return;
        }
        ['pointerdown', 'keydown', 'touchstart'].forEach((eventName) => {
          window.removeEventListener(eventName, this.resumeInteractionHandler);
        });
        this.resumeInteractionHandler = null;
      }
    });

    Alpine.store('radioPlayer').init();
  });
</script>

<script>
  (function () {
    const nowPlayingTitle = document.getElementById("nowplayingTitle");
    const nowPlayingHost = document.getElementById("nowplayingHost");
    const nowPlayingImage = document.getElementById("nowplayingImage");
    const nowPlayingDescription = document.getElementById("nowplayingDescription");
    const nowPlayingDescriptionClone = document.getElementById("nowplayingDescriptionClone");

    function sanitizeImagePath(name) {
      if (!name) {
        return "/assets/images/showalbums/placeholder.png";
      }
      const trimmed = name.trim();
      if (!trimmed) {
        return "/assets/images/showalbums/placeholder.png";
      }
      const sanitized = encodeURIComponent(trimmed).replace(/%2F/g, "/");
      return `/assets/images/showalbums/${sanitized}`;
    }

    function loadCurShow() {
      const showsData = window.WEBDCR_SHOWS || [];
      const daysOfWeek = [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday"
      ];
      const currentDate = new Date();
      const currentDay = daysOfWeek[currentDate.getDay()];
      const nowMinutes = currentDate.getHours() * 60 + currentDate.getMinutes();

      let matchingShow = null;

      for (let i = 0; i < showsData.length; i++) {
        const show = showsData[i];
        if (!show || show.Day !== currentDay) {
          continue;
        }
        const parser = window.webdcr && typeof window.webdcr.parseTimeToMinutes === 'function'
          ? window.webdcr.parseTimeToMinutes
          : null;
        const showStart = parser ? parser(show.Time) : NaN;
        if (Number.isNaN(showStart)) {
          continue;
        }
        if (nowMinutes >= showStart && nowMinutes < showStart + 60) {
          matchingShow = show;
          break;
        }
      }

      const title = matchingShow && matchingShow["Name"] ? matchingShow["Name"] : "WebDCR Music";
      const host = matchingShow && matchingShow["Host(s)"]
        ? `with ${matchingShow["Host(s)"]}`
        : "No show is currently playing";
      const description = matchingShow && matchingShow["Description"] ? matchingShow["Description"] : '';
      const art = sanitizeImagePath(matchingShow && matchingShow["Image name"]);

      if (nowPlayingTitle) {
        nowPlayingTitle.innerText = title;
      }
      if (nowPlayingHost) {
        nowPlayingHost.innerText = host;
      }
      if (nowPlayingImage) {
        nowPlayingImage.src = art;
      }
      const marqueeWrapper = document.querySelector('.nowplaying-description');
      if (marqueeWrapper && nowPlayingDescription && nowPlayingDescriptionClone) {
        if (description) {
          nowPlayingDescription.textContent = description;
          nowPlayingDescriptionClone.textContent = description;
          marqueeWrapper.style.display = '';
        } else {
          marqueeWrapper.style.display = 'none';
        }
      }
    }

    function scheduleShowUpdates() {
      const now = new Date();
      const nextMinute = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        now.getHours(),
        now.getMinutes() + 1,
        0,
        0
      );
      const delay = Math.max(nextMinute.getTime() - now.getTime(), 250);
      setTimeout(() => {
        loadCurShow();
        scheduleShowUpdates();
      }, delay);
    }

    loadCurShow();
    scheduleShowUpdates();
  })();
</script>
