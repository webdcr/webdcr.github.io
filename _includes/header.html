<div class="nowplaying-banner" role="region" aria-live="polite">
  <div class="nowplaying-inner">
    <div class="nowplaying-cover">
      <img
        src="/assets/images/showalbums/placeholder.png"
        alt="Artwork for the show that is currently live"
        id="nowplayingImage"
      />
    </div>
    <div class="nowplaying-copy">
      <p class="nowplaying-eyebrow">On air now</p>
      <p class="nowplaying-title" id="nowplayingTitle">WebDCR Music</p>
      <p class="nowplaying-host" id="nowplayingHost">No show is currently playing</p>
      <p class="nowplaying-description" style="display:none">
        <span class="nowplaying-description-track">
          <span class="nowplaying-description-segment">
            <span class="nowplaying-description-text" id="nowplayingDescription"></span>
            <span class="nowplaying-description-divider" aria-hidden="true">•</span>
          </span>
          <span class="nowplaying-description-segment" aria-hidden="true">
            <span class="nowplaying-description-text" id="nowplayingDescriptionClone"></span>
            <span class="nowplaying-description-divider" aria-hidden="true">•</span>
          </span>
        </span>
      </p>
    </div>
    <button
      type="button"
      id="radioPlayer"
      class="radioPlayer"
      data-mode="stopped"
      aria-label="Toggle the live stream"
      aria-pressed="false"
    ></button>
  </div>
</div>

<header class="site-header">
  <a class="wordmark-group wordmark-link" href="/" aria-label="WebDCR home">
    <h1 id="wordmark">WEBDCR</h1>
    <p class="tagline">Dartmouth College Radio</p>
  </a>

  <nav class="navbar" aria-label="Primary">
    <div class="nav-row">
      <a class="navitem" id="nav_home" href="/">home</a>
      <a class="navitem" id="nav_news" href="/news">news &amp; reports</a>
      <a class="navitem" id="nav_blog" href="/musicblog">music blog</a>
    </div>
    <div class="nav-row">
      <a class="navitem" id="nav_about" href="/about">about</a>
      <a class="navitem" id="nav_merch" href="/merch">merch</a>
      <a class="navitem" id="nav_alumni" href="/alumni">alumni corner</a>
    </div>
  </nav>
</header>

<script>
  (function () {
    const radioURL = "{{ site.liveradio_url | escape }}";
    const playerButton = document.getElementById("radioPlayer");
    const nowPlayingTitle = document.getElementById("nowplayingTitle");
    const nowPlayingHost = document.getElementById("nowplayingHost");
    const nowPlayingImage = document.getElementById("nowplayingImage");
    const nowPlayingDescription = document.getElementById("nowplayingDescription");
    const nowPlayingDescriptionClone = document.getElementById("nowplayingDescriptionClone");
    const STORAGE_KEY = 'webdcr.radio.playing';

    let radioAud;
    let playerState = "stopped";
    let isPageUnloading = false;

    const rememberPlaybackPreference = () => {
      try {
        localStorage.setItem(STORAGE_KEY, '1');
      } catch (e) {}
    };

    const clearPlaybackPreference = () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
    };

    const handlePageExit = () => {
      if (playerState === "playing" || playerState === "loading") {
        isPageUnloading = true;
        rememberPlaybackPreference();
      }
    };

    window.addEventListener("pagehide", handlePageExit);
    window.addEventListener("beforeunload", handlePageExit);
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        handlePageExit();
      } else {
        isPageUnloading = false;
      }
    });

    function setPlayerState(state) {
      playerState = state;
      if (!playerButton) return;
      playerButton.setAttribute("data-mode", state);
      playerButton.setAttribute("aria-pressed", state === "playing");
    }

    function ensureAudio() {
      if (radioAud) {
        return;
      }
      radioAud = new Audio(radioURL);
      radioAud.preload = "none";
      radioAud.addEventListener("waiting", () => setPlayerState("loading"));
      radioAud.addEventListener("playing", () => {
        isPageUnloading = false;
        setPlayerState("playing");
        rememberPlaybackPreference();
      });
      radioAud.addEventListener("pause", () => {
        setPlayerState("stopped");
        if (isPageUnloading) {
          return;
        }
        clearPlaybackPreference();
      });
      radioAud.addEventListener("ended", () => {
        setPlayerState("stopped");
        clearPlaybackPreference();
      });
      radioAud.addEventListener("error", () => {
        setPlayerState("stopped");
        clearPlaybackPreference();
      });
    }

    function toggleRadio() {
      ensureAudio();
      if (!radioAud) {
        return;
      }

      if (playerState === "playing" || playerState === "loading") {
        radioAud.pause();
        return;
      }

      try {
        radioAud.load();
        const playPromise = radioAud.play();
        if (playPromise && typeof playPromise.catch === "function") {
          playPromise.catch(() => setPlayerState("stopped"));
        }
      } catch (err) {
        setPlayerState("stopped");
      }
    }

    if (playerButton) {
      playerButton.addEventListener("click", toggleRadio);
    }

    try {
      if (localStorage.getItem(STORAGE_KEY) === '1') {
        ensureAudio();
        if (radioAud) {
          setPlayerState("loading");
        try {
          radioAud.load();
          const p = radioAud.play();
          if (p && typeof p.catch === 'function') {
            p.catch(() => {
              setPlayerState("stopped");
              clearPlaybackPreference();
            });
          }
        } catch (e) {
          setPlayerState("stopped");
          clearPlaybackPreference();
        }
      }
    }
  } catch (e) {}

    function to24Hour(timeString) {
      if (!timeString) {
        return NaN;
      }
      const parts = timeString.trim().split(/[:\s]/);
      const hours = parseInt(parts[0], 10);
      if (Number.isNaN(hours)) {
        return NaN;
      }
      const isPM = timeString.toUpperCase().includes("PM");
      return (hours % 12) + (isPM ? 12 : 0);
    }

    function sanitizeImagePath(name) {
      if (!name) {
        return "/assets/images/showalbums/placeholder.png";
      }
      const trimmed = name.trim();
      if (!trimmed) {
        return "/assets/images/showalbums/placeholder.png";
      }
      const sanitized = encodeURIComponent(trimmed).replace(/%2F/g, "/");
      return `/assets/images/showalbums/${sanitized}`;
    }

    function loadCurShow() {
      const showsData = {{ site.data.shows | jsonify }};
      const daysOfWeek = [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday"
      ];
      const currentDate = new Date();
      const currentDay = daysOfWeek[currentDate.getDay()];
      const currentHour = currentDate.getHours();

      let matchingShow = null;

      for (let i = 0; i < showsData.length; i++) {
        const show = showsData[i];
        if (show && show.Day === currentDay && to24Hour(show.Time) === currentHour) {
          matchingShow = show;
          break;
        }
      }

      const title = matchingShow && matchingShow["Name"] ? matchingShow["Name"] : "WebDCR Music";
      const host = matchingShow && matchingShow["Host(s)"]
        ? `with ${matchingShow["Host(s)"]}`
        : "No show is currently playing";
      const description = matchingShow && matchingShow["Description"] ? matchingShow["Description"] : '';
      const art = sanitizeImagePath(matchingShow && matchingShow["Image name"]);

      if (nowPlayingTitle) {
        nowPlayingTitle.innerText = title;
      }
      if (nowPlayingHost) {
        nowPlayingHost.innerText = host;
      }
      if (nowPlayingImage) {
        nowPlayingImage.src = art;
      }
      const marqueeWrapper = document.querySelector('.nowplaying-description');
      if (marqueeWrapper && nowPlayingDescription && nowPlayingDescriptionClone) {
        if (description) {
          nowPlayingDescription.textContent = description;
          nowPlayingDescriptionClone.textContent = description;
          marqueeWrapper.style.display = '';
        } else {
          marqueeWrapper.style.display = 'none';
        }
      }
    }

    loadCurShow();
    setInterval(loadCurShow, 30 * 60 * 1000);
  })();
</script>
