{% unless page.hide_nowplaying %}
<div class="nowplaying-banner" role="region" aria-live="polite">
  <div class="nowplaying-inner">
    <div class="nowplaying-cover">
      <img
        src="/assets/images/showalbums/placeholder.png"
        alt="Artwork for the show that is currently live"
        id="nowplayingImage"
      />
    </div>
    <div class="nowplaying-copy">
      <p class="nowplaying-eyebrow">On air now</p>
      <p class="nowplaying-title" id="nowplayingTitle">WebDCR Music</p>
      <p class="nowplaying-host" id="nowplayingHost">No show is currently playing</p>
      <p class="nowplaying-description" style="display:none">
        <span class="nowplaying-description-static" id="nowplayingDescriptionStatic"></span>
        <span class="nowplaying-description-track" aria-hidden="true">
          <span class="nowplaying-description-segment">
            <span class="nowplaying-description-text" id="nowplayingDescription"></span>
            <span class="nowplaying-description-divider" aria-hidden="true">•</span>
          </span>
          <span class="nowplaying-description-segment" aria-hidden="true">
            <span class="nowplaying-description-text" id="nowplayingDescriptionClone"></span>
            <span class="nowplaying-description-divider" aria-hidden="true">•</span>
          </span>
        </span>
      </p>
    </div>
    <button
      type="button"
      id="radioPlayer"
      class="radioPlayer"
      x-data
      :data-mode="$store.radioPlayer ? $store.radioPlayer.state : 'stopped'"
      aria-label="Toggle the live stream"
      :aria-pressed="$store.radioPlayer ? ($store.radioPlayer.state === 'playing').toString() : 'false'"
      @click="$store.radioPlayer && $store.radioPlayer.toggle()"
    ></button>
  </div>
</div>
{% endunless %}

<header class="site-header">
  <a class="wordmark-group wordmark-link" href="/" aria-label="WebDCR home">
    <h1 id="wordmark">WEBDCR</h1>
    <p class="tagline">Dartmouth College Radio</p>
  </a>

  <nav class="navbar" aria-label="Primary">
    <div class="nav-row">
      <a class="navitem" id="nav_home" href="/">home</a>
      <a class="navitem" id="nav_news" href="/news">news &amp; reports</a>
      <a class="navitem" id="nav_blog" href="/musicblog">music blog</a>
    </div>
    <div class="nav-row">
      <a class="navitem" id="nav_about" href="/about">about</a>
      <a class="navitem" id="nav_merch" href="/merch">merch</a>
      <a class="navitem" id="nav_alumni" href="/alumni">alumni corner</a>
    </div>
  </nav>
</header>

<script>
  window.WEBDCR_SHOWS = window.WEBDCR_SHOWS || {{ site.data.shows | jsonify }};
  window.webdcr = window.webdcr || {};
  window.webdcr.parseTimeToMinutes = function (timeString) {
    if (!timeString) {
      return NaN;
    }
    const trimmed = String(timeString).trim();
    const match = trimmed.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?$/i);
    if (!match) {
      return NaN;
    }
    let hours = parseInt(match[1], 10);
    const minutes = match[2] ? parseInt(match[2], 10) : 0;
    const meridiem = match[3] ? match[3].toUpperCase() : null;
    if (meridiem === "PM" && hours < 12) {
      hours += 12;
    }
    if (meridiem === "AM" && hours === 12) {
      hours = 0;
    }
    if (!meridiem && (hours < 0 || hours >= 24)) {
      return NaN;
    }
    if (minutes < 0 || minutes >= 60) {
      return NaN;
    }
    return hours * 60 + minutes;
  };

  window.webdcr.getEasternNowComponents = (function () {
    const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const EASTERN_TIME_ZONE = 'America/New_York';
    let formatter = null;
    if (typeof Intl !== 'undefined' && typeof Intl.DateTimeFormat === 'function') {
      try {
        formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: EASTERN_TIME_ZONE,
          weekday: 'long',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
      } catch (error) {
        formatter = null;
      }
    }

    function fallback(date) {
      const MINUTES_PER_DAY = 1440;
      const EST_OFFSET = 300;
      const utcMinutes = date.getUTCHours() * 60 + date.getUTCMinutes();
      let minutes = utcMinutes - EST_OFFSET;
      let dayIndex = date.getUTCDay();
      while (minutes < 0) {
        minutes += MINUTES_PER_DAY;
        dayIndex = (dayIndex + 6) % 7;
      }
      while (minutes >= MINUTES_PER_DAY) {
        minutes -= MINUTES_PER_DAY;
        dayIndex = (dayIndex + 1) % 7;
      }
      return {
        dayName: DAY_NAMES[dayIndex],
        dayIndex,
        minutes
      };
    }

    return function getEasternNowComponents(date = new Date()) {
      if (formatter && typeof formatter.formatToParts === 'function') {
        try {
          const parts = formatter.formatToParts(date);
          const dayName = parts.find((part) => part.type === 'weekday')?.value || 'Sunday';
          const hourPart = parts.find((part) => part.type === 'hour');
          const minutePart = parts.find((part) => part.type === 'minute');
          const hours = hourPart ? parseInt(hourPart.value, 10) : 0;
          const minutes = minutePart ? parseInt(minutePart.value, 10) : 0;
          const safeDayIndex = DAY_NAMES.indexOf(dayName);
          return {
            dayName: safeDayIndex >= 0 ? DAY_NAMES[safeDayIndex] : DAY_NAMES[0],
            dayIndex: safeDayIndex >= 0 ? safeDayIndex : 0,
            minutes: hours * 60 + minutes
          };
        } catch (error) {
          return fallback(date);
        }
      }
      return fallback(date);
    };
  })();
</script>

<script>
  document.addEventListener('alpine:init', () => {
    const radioURL = "{{ site.liveradio_url | escape }}";
    const STORAGE_KEY = 'webdcr.radio.playing';
    const TAB_STORAGE_KEY = 'webdcr.radio.tabid';
    const MAX_RESUME_AGE_MS = 4000;
    const HEARTBEAT_INTERVAL_MS = 1000;

    function generateTabId() {
      return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    const TAB_ID = (() => {
      try {
        const stored = sessionStorage.getItem(TAB_STORAGE_KEY);
        if (stored) {
          return stored;
        }
        const newId = generateTabId();
        sessionStorage.setItem(TAB_STORAGE_KEY, newId);
        return newId;
      } catch (e) {
        return generateTabId();
      }
    })();

    Alpine.store('radioPlayer', {
      state: 'stopped',
      audio: null,
      isPageUnloading: false,
      resumeInteractionHandler: null,
      heartbeatId: null,
      init() {
        this.registerLifecycleHandlers();
        this.resumeIfNeeded();
      },
      isActive() {
        return this.state === 'playing' || this.state === 'loading';
      },
      registerLifecycleHandlers() {
        const exitHandler = () => this.handlePageExit();
        window.addEventListener('pagehide', exitHandler);
        window.addEventListener('beforeunload', exitHandler);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'hidden') {
            this.handlePageExit();
          } else {
            this.isPageUnloading = false;
          }
        });
        const linkNavIntentHandler = (event, options = {}) => {
          if (event.defaultPrevented) {
            return;
          }
          if (options.requirePrimaryButton && event.button !== 0) {
            return;
          }
          if (options.ignoreModifierKeys && this.hasModifierKey(event)) {
            return;
          }
          const target = event.target;
          if (!target || typeof target.closest !== 'function') {
            return;
          }
          const anchor = target.closest('a[href]');
          if (!anchor || this.shouldIgnoreAnchor(anchor)) {
            return;
          }
          this.prepareForPageExit();
        };
        document.addEventListener(
          'click',
          (event) => linkNavIntentHandler(event, { requirePrimaryButton: true, ignoreModifierKeys: true }),
          true
        );
        document.addEventListener(
          'keydown',
          (event) => {
            if (event.key !== 'Enter' && event.key !== ' ') {
              return;
            }
            linkNavIntentHandler(event, { ignoreModifierKeys: true });
          },
          true
        );
      },
      ensureAudio() {
        if (this.audio) {
          return;
        }
        this.audio = new Audio(radioURL);
        this.audio.preload = 'none';
        this.audio.addEventListener('waiting', () => this.setState('loading'));
        this.audio.addEventListener('playing', () => {
          this.isPageUnloading = false;
          this.setState('playing');
          this.cancelResumeOnInteraction();
          this.rememberPlaybackPreference();
        });
        this.audio.addEventListener('pause', () => {
          this.stopHeartbeat();
          this.setState('stopped');
          if (!this.isPageUnloading) {
            this.cancelResumeOnInteraction();
            this.clearPlaybackPreference();
          }
        });
        ['ended', 'error'].forEach((eventName) => {
          this.audio.addEventListener(eventName, () => {
            this.stopHeartbeat();
            this.setState('stopped');
            this.cancelResumeOnInteraction();
            this.clearPlaybackPreference();
          });
        });
      },
      setState(state) {
        this.state = state;
      },
      toggle() {
        if (this.state === 'playing' || this.state === 'loading') {
          this.pause();
        } else {
          this.play();
        }
      },
      play(options = {}) {
        const initiatedByResume = !!options.initiatedByResume;
        this.ensureAudio();
        if (!this.audio) {
          return;
        }
        this.rememberPlaybackPreference();
        this.cancelResumeOnInteraction();
        this.setState('loading');
        try {
          this.audio.load();
          const playPromise = this.audio.play();
          if (playPromise && typeof playPromise.catch === 'function') {
            playPromise.catch((err) => {
              this.handlePlayError(err, initiatedByResume);
            });
          }
        } catch (err) {
          this.handlePlayError(err, initiatedByResume);
        }
      },
      pause() {
        if (this.audio) {
          this.audio.pause();
        } else {
          this.stopHeartbeat();
          this.setState('stopped');
          this.clearPlaybackPreference();
        }
      },
      rememberPlaybackPreference(options = {}) {
        this.writePlaybackPreference(Date.now());
        if (!options.skipHeartbeat) {
          this.startHeartbeat();
        }
      },
      clearPlaybackPreference(options = {}) {
        const force = !!options.force;
        if (!force) {
          const current = this.readPlaybackPreference();
          if (
            current &&
            current.tabId &&
            current.tabId !== TAB_ID &&
            Date.now() - current.timestamp <= MAX_RESUME_AGE_MS
          ) {
            return;
          }
        }
        this.stopHeartbeat();
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (e) {}
      },
      handlePageExit() {
        this.prepareForPageExit();
      },
      resumeIfNeeded() {
        const record = this.readPlaybackPreference();
        if (!record) {
          this.clearPlaybackPreference({ force: true });
          return;
        }
        const age = Date.now() - record.timestamp;
        if (record.tabId && record.tabId !== TAB_ID) {
          if (age > MAX_RESUME_AGE_MS) {
            this.clearPlaybackPreference({ force: true });
          }
          return;
        }
        if (age <= MAX_RESUME_AGE_MS) {
          this.play({ initiatedByResume: true });
        } else {
          this.clearPlaybackPreference({ force: true });
        }
      },
      prepareForPageExit() {
        if (!this.isActive()) {
          return;
        }
        this.isPageUnloading = true;
        this.rememberPlaybackPreference({ skipHeartbeat: true });
      },
      handlePlayError(err, initiatedByResume) {
        if (initiatedByResume && this.isAutoplayBlockedError(err)) {
          // Autoplay gets rejected until a user interacts with the page again.
          this.setState('stopped');
          this.scheduleResumeOnInteraction();
          return;
        }
        this.stopHeartbeat();
        this.setState('stopped');
        this.clearPlaybackPreference();
      },
      startHeartbeat() {
        if (this.heartbeatId !== null) {
          return;
        }
        this.heartbeatId = window.setInterval(() => {
          this.writePlaybackPreference(Date.now());
        }, HEARTBEAT_INTERVAL_MS);
      },
      stopHeartbeat() {
        if (this.heartbeatId !== null) {
          window.clearInterval(this.heartbeatId);
          this.heartbeatId = null;
        }
      },
      readPlaybackPreference() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            return null;
          }
          let parsed;
          try {
            parsed = JSON.parse(raw);
          } catch (err) {
            parsed = null;
          }
          if (parsed && typeof parsed === 'object') {
            const timestamp = Number(parsed.timestamp);
            const tabId = typeof parsed.tabId === 'string' ? parsed.tabId : null;
            if (!Number.isFinite(timestamp)) {
              return null;
            }
            return { timestamp, tabId };
          }
          const legacy = Number(raw);
          if (Number.isFinite(legacy)) {
            return { timestamp: legacy, tabId: null };
          }
          return null;
        } catch (e) {
          return null;
        }
      },
      writePlaybackPreference(timestamp) {
        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({ timestamp, tabId: TAB_ID })
          );
        } catch (e) {}
      },
      hasModifierKey(event) {
        return !!(event.metaKey || event.ctrlKey || event.altKey || event.shiftKey);
      },
      shouldIgnoreAnchor(anchor) {
        if (!anchor) {
          return true;
        }
        if (anchor.target && anchor.target !== '' && anchor.target.toLowerCase() !== '_self') {
          return true;
        }
        if (anchor.hasAttribute('download')) {
          return true;
        }
        const href = anchor.getAttribute('href');
        if (!href || href.startsWith('#') || href.startsWith('javascript:')) {
          return true;
        }
        let url;
        try {
          url = new URL(href, window.location.href);
        } catch (e) {
          return true;
        }
        if (url.origin !== window.location.origin) {
          return true;
        }
        if (url.pathname === window.location.pathname && url.search === window.location.search) {
          return true;
        }
        return false;
      },
      isAutoplayBlockedError(err) {
        if (!err) {
          return false;
        }
        const name = err.name || '';
        if (name === 'NotAllowedError' || name === 'SecurityError') {
          return true;
        }
        if (typeof err.message === 'string') {
          const lowercase = err.message.toLowerCase();
          return (
            lowercase.includes('gesture') ||
            lowercase.includes('interaction') ||
            lowercase.includes('autoplay') ||
            lowercase.includes('not allowed')
          );
        }
        return false;
      },
      scheduleResumeOnInteraction() {
        if (this.resumeInteractionHandler) {
          return;
        }
        // Resume immediately on the next user gesture.
        this.resumeInteractionHandler = () => {
          this.cancelResumeOnInteraction();
          this.play({ initiatedByResume: true });
        };
        ['pointerdown', 'keydown', 'touchstart'].forEach((eventName) => {
          window.addEventListener(eventName, this.resumeInteractionHandler, { once: true });
        });
      },
      cancelResumeOnInteraction() {
        if (!this.resumeInteractionHandler) {
          return;
        }
        ['pointerdown', 'keydown', 'touchstart'].forEach((eventName) => {
          window.removeEventListener(eventName, this.resumeInteractionHandler);
        });
        this.resumeInteractionHandler = null;
      }
    });

    Alpine.store('radioPlayer').init();
  });
</script>

<script>
  (function () {
    const nowPlayingTitle = document.getElementById("nowplayingTitle");
    const nowPlayingHost = document.getElementById("nowplayingHost");
    const nowPlayingImage = document.getElementById("nowplayingImage");
    const nowPlayingDescription = document.getElementById("nowplayingDescription");
    const nowPlayingDescriptionClone = document.getElementById("nowplayingDescriptionClone");
    const nowPlayingDescriptionStatic = document.getElementById("nowplayingDescriptionStatic");
    const marqueeWrapper = document.querySelector('.nowplaying-description');

    function updateMarqueeState(wrapper) {
      if (!wrapper) {
        return;
      }
      wrapper.classList.remove('nowplaying-description--marquee');
      const track = wrapper.querySelector('.nowplaying-description-track');
      const firstSegment = wrapper.querySelector('.nowplaying-description-segment');
      const staticText = wrapper.querySelector('.nowplaying-description-static');
      const wrapperWidth = wrapper.getBoundingClientRect().width;
      let baseContentWidth = 0;
      if (staticText && staticText.textContent) {
        baseContentWidth = staticText.scrollWidth;
      }
      if (!baseContentWidth && firstSegment) {
        baseContentWidth = firstSegment.getBoundingClientRect().width;
      }
      const needsMarquee = baseContentWidth > wrapperWidth + 16;
      if (needsMarquee) {
        wrapper.classList.add('nowplaying-description--marquee');
      } else {
        wrapper.classList.remove('nowplaying-description--marquee');
      }
      const trackWidth = track ? Math.max(track.scrollWidth, track.getBoundingClientRect().width) : baseContentWidth;
      if (needsMarquee && track && trackWidth > 0) {
        const SCROLL_SPEED = 28;
        const MIN_DURATION = 20;
        const durationSeconds = Math.max(trackWidth / SCROLL_SPEED, MIN_DURATION);
        track.style.setProperty('--marquee-duration', `${durationSeconds}s`);
      } else if (track) {
        track.style.removeProperty('--marquee-duration');
      }
    }

    function sanitizeImagePath(name) {
      if (!name) {
        return "/assets/images/showalbums/placeholder.png";
      }
      const trimmed = name.trim();
      if (!trimmed) {
        return "/assets/images/showalbums/placeholder.png";
      }
      const sanitized = encodeURIComponent(trimmed).replace(/%2F/g, "/");
      return `/assets/images/showalbums/${sanitized}`;
    }

    function loadCurShow() {
      const showsData = window.WEBDCR_SHOWS || [];
      const daysOfWeek = [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday"
      ];
      const easternNow = window.webdcr && typeof window.webdcr.getEasternNowComponents === 'function'
        ? window.webdcr.getEasternNowComponents()
        : { dayName: daysOfWeek[new Date().getDay()], minutes: new Date().getHours() * 60 + new Date().getMinutes() };
      const currentDay = easternNow.dayName;
      const nowMinutes = easternNow.minutes;

      let matchingShow = null;

      for (let i = 0; i < showsData.length; i++) {
        const show = showsData[i];
        if (!show || show.Day !== currentDay) {
          continue;
        }
        const parser = window.webdcr && typeof window.webdcr.parseTimeToMinutes === 'function'
          ? window.webdcr.parseTimeToMinutes
          : null;
        const showStart = parser ? parser(show.Time) : NaN;
        if (Number.isNaN(showStart)) {
          continue;
        }
        if (nowMinutes >= showStart && nowMinutes < showStart + 60) {
          matchingShow = show;
          break;
        }
      }

      const title = matchingShow && matchingShow["Name"] ? matchingShow["Name"] : "WebDCR Music";
      const host = matchingShow && matchingShow["Host(s)"]
        ? `with ${matchingShow["Host(s)"]}`
        : "No show is currently playing";
      const description = matchingShow && matchingShow["Description"] ? matchingShow["Description"] : '';
      const art = sanitizeImagePath(matchingShow && matchingShow["Image name"]);

      if (nowPlayingTitle) {
        nowPlayingTitle.innerText = title;
      }
      if (nowPlayingHost) {
        nowPlayingHost.innerText = host;
      }
      if (nowPlayingImage) {
        nowPlayingImage.src = art;
      }
      if (marqueeWrapper && nowPlayingDescription && nowPlayingDescriptionClone) {
        if (description) {
          nowPlayingDescription.textContent = description;
          nowPlayingDescriptionClone.textContent = description;
          if (nowPlayingDescriptionStatic) {
            nowPlayingDescriptionStatic.textContent = description;
          }
          marqueeWrapper.style.display = '';
          requestAnimationFrame(() => updateMarqueeState(marqueeWrapper));
        } else {
          marqueeWrapper.style.display = 'none';
          nowPlayingDescription.textContent = '';
          nowPlayingDescriptionClone.textContent = '';
          if (nowPlayingDescriptionStatic) {
            nowPlayingDescriptionStatic.textContent = '';
          }
          marqueeWrapper.classList.remove('nowplaying-description--marquee');
          const track = marqueeWrapper.querySelector('.nowplaying-description-track');
          if (track) {
            track.style.removeProperty('--marquee-duration');
          }
        }
      }
    }

    function scheduleShowUpdates() {
      const now = new Date();
      const nextMinute = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        now.getHours(),
        now.getMinutes() + 1,
        0,
        0
      );
      const delay = Math.max(nextMinute.getTime() - now.getTime(), 250);
      setTimeout(() => {
        loadCurShow();
        scheduleShowUpdates();
      }, delay);
    }

    loadCurShow();
    scheduleShowUpdates();

    let resizeRaf = null;
    const queueMarqueeUpdate = () => {
      if (!marqueeWrapper || marqueeWrapper.style.display === 'none') {
        return;
      }
      if (resizeRaf) {
        cancelAnimationFrame(resizeRaf);
      }
      resizeRaf = requestAnimationFrame(() => {
        updateMarqueeState(marqueeWrapper);
        resizeRaf = null;
      });
    };

    let lastMeasuredWidth = marqueeWrapper ? Math.round(marqueeWrapper.getBoundingClientRect().width) : null;
    if (marqueeWrapper && 'ResizeObserver' in window) {
      const marqueeResizeObserver = new ResizeObserver((entries) => {
        for (const entry of entries) {
          if (entry.target !== marqueeWrapper) {
            continue;
          }
          const measuredWidth = Math.round(entry.contentRect ? entry.contentRect.width : entry.target.getBoundingClientRect().width);
          if (lastMeasuredWidth === measuredWidth) {
            return;
          }
          lastMeasuredWidth = measuredWidth;
          queueMarqueeUpdate();
        }
      });
      marqueeResizeObserver.observe(marqueeWrapper);
    } else {
      window.addEventListener('resize', () => {
        if (!marqueeWrapper) {
          return;
        }
        const measuredWidth = Math.round(marqueeWrapper.getBoundingClientRect().width);
        if (lastMeasuredWidth === measuredWidth) {
          return;
        }
        lastMeasuredWidth = measuredWidth;
        queueMarqueeUpdate();
      });
    }
  })();
</script>
